<html>
<head>
  <title>Phishing Detection System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix"></script>
</head>

<body>
<h2>Phishing Detector System</h2>

<form method="POST">
<textarea name="email" placeholder="Paste email content here..."></textarea>
    <button type="submit">Check Email</button>
</form>

{% if prediction %}
<div class="result">Prediction Result: {{ prediction }}</div>
{% endif %}

<!-- Model performance Evaluation Table -->
 <center><b>Model Performance Evaluation Table</b></center>

<table id="metricsTable" class="metrics-table">
    <thead>
        <tr>
            <th>Model</th>
            <th>Accuracy</th>
            <th>Precision</th>
            <th>Recall</th>
            <th>F1-Score</th>
        </tr>
    </thead>
    <tbody>
        <!-- Rows will be injected by JavaScript -->
    </tbody>
</table>
<!-- Accuracy / Precision / Recall / F1 Chart -->
<div class="chart-box">
<canvas id="metricChart"></canvas>
</div>

<!-- Confusion Matrix Heatmap -->
<div class="chart-box">
<canvas id="confusionChart"></canvas>
</div>

<canvas id="chart"></canvas>

<script>

/* ===== LOAD DATA FROM FLASK ===== */
const metrics = {{ metrics | safe }};
const confusion = {{ confusion | safe }};

  // ===== METRICS BAR CHART =====
new Chart(document.getElementById("metricChart"), {
    type: "bar",
    data: {
        labels: ["Naive Bayes", "SVM", "Random Forest"],
        datasets: [
            { label: "Accuracy", data: metrics.accuracy, backgroundColor: '#36a2eb' },
            { label: "Precision", data: metrics.precision, backgroundColor: '#ff6384' },
            { label: "Recall", data: metrics.recall, backgroundColor: '#4bc0c0' },
            { label: "F1-Score", data: metrics.f1, backgroundColor: '#ff9f40' }
        ]
    },
    options: {
        plugins: {
            title: {
                display: true,
                text: "Model Performance Comparison"
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                max: 1
            }
        }
    }
});

// ===== CONFUSION MATRIX HEATMAP =====
new Chart(document.getElementById("confusionChart"), {
    type: "matrix",
    data: {
        datasets: [{
            label: 'Confusion Matrix',
            data: [
                {x: 0, y: 1, v: confusion[0][0], label: "TN"},
                {x: 1, y: 1, v: confusion[0][1], label: "FP"},
                {x: 0, y: 0, v: confusion[1][0], label: "FN"},
                {x: 1, y: 0, v: confusion[1][1], label: "TP"}
            ],
            backgroundColor(ctx) {
              // Safety check to ensure data exists before accessing 'v'
                if (!ctx.dataset.data[ctx.dataIndex]) return 'rgba(0,0,0,0.1)';
                const value = ctx.dataset.data[ctx.dataIndex].v;
                const alpha = (value / 800) + 0.1;
                return `rgba(31,119,180,${alpha})`;
            },
            width: ({chart}) => (chart.chartArea || {}).width / 2 - 1,
            height: ({chart}) => (chart.chartArea || {}).height / 2 - 1
        }]
    },
    options: {
        plugins: {
            tooltip: {
                callbacks: {
                    title: () => "", // Hide title
                    label: (ctx) => {
                        const v = ctx.raw.v;
                        return `Count: ${v}`;
                    }
                }
            },
            legend: { display: false },
            title: { display: true, text: "Confusion Matrix Heatmap" },
            tooltip: {
                callbacks: {
                    label: ctx =>
                        `${ctx.raw.label}: ${ctx.raw.r}`
                }
            }
        },
        scales: {
            x: {
                type: 'linear', // Matrix works best with linear or category scales
                min: -0.5,
                max: 1.5,
                ticks: { 
                    stepSize: 1,
                    callback: v => v === 0 ? "Phishing" : "Legitimate"
                }
            },
            y: {
                type: 'linear',
                min: -0.5,
                max: 1.5,
                ticks: { 
                    stepSize: 1,
                    callback: v => v === 0 ? "Actual Phish" : (v === 1 ? "Actual Legit" : "") 
                }
            }
        }
    }
});

const modelNames = ["Naive Bayes", "SVM", "Random Forest"];
const tableBody = document.querySelector("#metricsTable tbody");

modelNames.forEach((model, index) => {
    const row = document.createElement("tr");

    row.innerHTML = `
        <td>${model}</td>
        <td>${metrics.accuracy[index] * 100}%</td>
        <td>${metrics.precision[index] * 100}%</td>
        <td>${metrics.recall[index] * 100}%</td>
        <td>${metrics.f1[index] * 100}%</td>
    `;

    tableBody.appendChild(row);
});
//  const cm = {{ metrics | tojson }};

// // Metric formulas
// function compute(m){
//   const acc=(m.TP+m.TN)/(m.TP+m.TN+m.FP+m.FN);
//   const prec=m.TP/(m.TP+m.FP);
//   const rec=m.TP/(m.TP+m.FN);
//   const f1=2*(prec*rec)/(prec+rec);

//   return {
//     acc: acc*100,
//     prec: prec*100,
//     rec: rec*100,
//     f1: f1*100
//   };
// }

// const r=compute(cm);

// // ================= Radar Chart =================
// new Chart(document.getElementById("chart"), {
//  type:"radar",
//  data:{
//   labels:["Accuracy","Precision","Recall","F1"],
//   datasets:[{
//     label:"Model Performance",
//     data:[r.acc,r.prec,r.rec,r.f1]
//   }]
//  },
//  options:{
//   scales:{ r:{ min:0,max:100 } }
//  }
// });

// // ================= Table =================
// const table=`
// <table border="1" style="margin-top:20px">
// <tr>
// <th>Accuracy</th><th>Precision</th>
// <th>Recall</th><th>F1</th>
// </tr>
// <tr>
// <td>${r.acc.toFixed(2)}%</td>
// <td>${r.prec.toFixed(2)}%</td>
// <td>${r.rec.toFixed(2)}%</td>
// <td>${r.f1.toFixed(2)}%</td>
// </tr>
// </table>
// `;

// document.body.insertAdjacentHTML("beforeend",table);
</script>

</body>
</html>
